<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon-Sync Evolved | Chaos Edition</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #8b5cf6; --cyber: #06b6d4; }
        body { background: #020203; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; height: 100vh; overflow: hidden; }
        .cyber-grid { background-image: linear-gradient(to right, #ffffff05 1px, transparent 1px), linear-gradient(to bottom, #ffffff05 1px, transparent 1px); background-size: 40px 40px; }
        .lyric-line { transition: all 0.2s cubic-bezier(0.23, 1, 0.32, 1); opacity: 0.1; filter: grayscale(1) blur(2px); transform: scale(0.85); line-height: 1.2; }
        .lyric-active { opacity: 1; filter: grayscale(0) blur(0); transform: scale(1.1) translateX(10px); color: #fff; text-shadow: 0 0 30px var(--neon); font-weight: 800; }
        .combo-anim { animation: pulse 0.3s ease-in-out; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #fbbf24; } 100% { transform: scale(1); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(10, 10, 15, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.05); }
    </style>
</head>
<body class="cyber-grid flex flex-col">

    <div id="setup-screen" class="fixed inset-0 z-[100] bg-[#020203] flex items-center justify-center p-6">
        <div class="max-w-lg w-full space-y-8">
            <div class="text-center space-y-2">
                <h1 class="text-6xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-violet-500 via-fuchsia-400 to-cyan-400">NEON-SYNC</h1>
                <p class="text-xs font-mono text-cyan-500 uppercase tracking-[0.5em]">Evolutionary Interface // High Performance</p>
            </div>
            <div class="glass-panel p-8 rounded-3xl space-y-6">
                <input type="text" id="video-url" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none focus:border-cyan-500 text-center text-xl transition-all font-mono" placeholder="PASTE YOUTUBE LINK">
                <button onclick="bootSystem()" class="w-full bg-gradient-to-r from-violet-600 to-cyan-600 hover:brightness-125 py-5 rounded-2xl font-black text-2xl uppercase tracking-widest shadow-[0_0_30px_rgba(139,92,246,0.3)]">INICIAR SEQUÊNCIA</button>
            </div>
            <div id="status-msg" class="text-center text-sm font-mono text-white/20 animate-pulse uppercase tracking-widest hidden">Hackeando letras e sincronizando tempo...</div>
        </div>
    </div>

    <main class="flex-1 flex overflow-hidden">
        <div class="w-2/3 flex flex-col relative border-r border-white/5">
            <div id="player" class="flex-1 bg-black"></div>
            
            <div class="absolute top-6 left-6 space-y-4 pointer-events-none">
                <div class="glass-panel px-6 py-4 rounded-2xl">
                    <p class="text-[10px] uppercase tracking-widest text-white/40">Total Score</p>
                    <p id="score" class="text-5xl font-bold text-cyan-400 font-mono">000000</p>
                    <div id="combo-container" class="opacity-0 transition-opacity">
                        <span id="combo-val" class="text-2xl font-black text-yellow-400 italic">COMBO X1</span>
                    </div>
                </div>
            </div>

            <div class="h-32 glass-panel border-t-0 flex items-end px-4 gap-1">
                <canvas id="visualizer" class="w-full h-full opacity-60"></canvas>
            </div>
        </div>

        <div class="w-1/3 flex flex-col relative bg-black/40">
            <div class="absolute top-0 w-full h-40 bg-gradient-to-b from-[#020203] z-10"></div>
            <div id="lyrics-container" class="flex-1 overflow-y-auto py-[45vh] px-10 space-y-16 no-scrollbar scroll-smooth">
                <div class="text-center opacity-20 italic">Aguardando sinal...</div>
            </div>
            <div class="absolute bottom-0 w-full h-40 bg-gradient-to-t from-[#020203] z-10"></div>
        </div>
    </main>

    <footer class="h-20 glass-panel flex items-center justify-between px-10 z-50">
        <div class="flex items-center gap-8">
            <div class="flex flex-col">
                <span class="text-[10px] uppercase text-white/30">Sync Offset</span>
                <span id="offset-display" class="font-mono text-cyan-400 font-bold">0.00s</span>
            </div>
            <p class="text-[10px] text-white/20 max-w-[150px] leading-tight font-mono">USE AS SETAS <br>← ADIANTAR | ATRASAR →</p>
        </div>

        <div class="flex gap-4">
            <button onclick="location.reload()" class="px-8 py-3 bg-white/5 hover:bg-red-500/20 text-white/60 hover:text-red-400 rounded-xl text-xs font-bold uppercase tracking-widest transition-all border border-white/5">Abortar</button>
            <button onclick="bootSystem()" class="px-8 py-3 bg-cyan-500/10 hover:bg-cyan-500 text-cyan-400 hover:text-white rounded-xl text-xs font-bold uppercase tracking-widest transition-all border border-cyan-500/20">Próxima</button>
        </div>
    </footer>

    <script>
        let player, audioCtx, analyser, dataArray, lyrics = [];
        let score = 0, combo = 0, timeOffset = -0.2; // Offset padrão para latência

        // Atalhos de Teclado para Sincronia em Tempo Real
        window.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowLeft') adjustSync(-0.05);
            if(e.key === 'ArrowRight') adjustSync(0.05);
        });

        function adjustSync(val) {
            timeOffset = parseFloat((timeOffset + val).toFixed(2));
            document.getElementById('offset-display').innerText = (timeOffset > 0 ? '+' : '') + timeOffset.toFixed(2) + 's';
        }

        async function bootSystem() {
            const url = document.getElementById('video-url').value;
            const videoId = extractVideoID(url);
            if(!videoId) return alert("Link inválido");

            document.getElementById('status-msg').classList.remove('hidden');

            try {
                const meta = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`).then(r => r.json());
                const lrcRes = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(meta.title)}`).then(r => r.json());
                const best = lrcRes.find(i => i.syncedLyrics);
                if(!best) throw new Error("Letras não encontradas no banco.");

                parseLRC(best.syncedLyrics);
                renderLyrics();
                
                if(!player) {
                    player = new YT.Player('player', {
                        height: '100%', width: '100%', videoId: videoId,
                        playerVars: { autoplay: 1, controls: 0, modestbranding: 1 },
                        events: { onStateChange: (e) => { if(e.data === 1) loop(); } }
                    });
                } else {
                    player.loadVideoById(videoId);
                }

                initAudio();
                document.getElementById('setup-screen').style.display = 'none';
            } catch (err) {
                alert(err.message);
                document.getElementById('status-msg').classList.add('hidden');
            }
        }

        function parseLRC(lrc) {
            lyrics = [];
            const reg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lrc.split('\n').forEach(line => {
                const m = reg.exec(line);
                if (m) {
                    const time = parseInt(m[1])*60 + parseInt(m[2]) + (m[3].length === 3 ? m[3]/1000 : m[3]/100);
                    lyrics.push({ time, text: line.replace(reg, '').trim() });
                }
            });
        }

        function renderLyrics() {
            document.getElementById('lyrics-container').innerHTML = lyrics.map((l, i) => 
                `<div id="lyric-${i}" class="lyric-line text-4xl md:text-6xl uppercase font-bold tracking-tighter">${l.text}</div>`
            ).join('');
        }

        function loop() {
            if (player.getPlayerState() !== 1) return;
            const now = player.getCurrentTime() + timeOffset;

            lyrics.forEach((l, i) => {
                const el = document.getElementById(`lyric-${i}`);
                if (now >= l.time && (i === lyrics.length - 1 || now < lyrics[i+1].time)) {
                    if (!el.classList.contains('lyric-active')) {
                        document.querySelectorAll('.lyric-line').forEach(x => x.classList.remove('lyric-active'));
                        el.classList.add('lyric-active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    updateScore();
                }
            });
            requestAnimationFrame(loop);
        }

        async function initAudio() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 512;
            audioCtx.createMediaStreamSource(stream).connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawViz();
        }

        function updateScore() {
            analyser.getByteFrequencyData(dataArray);
            
            // Cálculo RMS para detecção de energia real (ignora picos de ruído)
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i] * dataArray[i];
            const rms = Math.sqrt(sum / dataArray.length);

            if (rms > 35) { // Threshold de canto
                combo = Math.min(combo + 0.05, 10);
                score += Math.floor((rms / 2) * (1 + combo/5));
                
                const comboEl = document.getElementById('combo-container');
                comboEl.style.opacity = '1';
                document.getElementById('combo-val').innerText = `COMBO X${Math.floor(combo)}`;
                document.getElementById('combo-val').classList.add('combo-anim');
                setTimeout(() => document.getElementById('combo-val').classList.remove('combo-anim'), 300);
            } else {
                combo = Math.max(0, combo - 0.1);
                if(combo === 0) document.getElementById('combo-container').style.opacity = '0';
            }
            document.getElementById('score').innerText = score.toString().padStart(6, '0');
        }

        function drawViz() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            const draw = () => {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                ctx.clearRect(0,0,canvas.width, canvas.height);
                const barWidth = (canvas.width / dataArray.length) * 2;
                dataArray.forEach((v, i) => {
                    const h = (v/255)*canvas.height;
                    const hue = 260 + (i * 0.5);
                    ctx.fillStyle = `hsla(${hue}, 80%, 60%, ${v/255})`;
                    ctx.fillRect(i*barWidth, canvas.height-h, barWidth - 1, h);
                });
            };
            draw();
        }

        function extractVideoID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : false;
        }
    </script>
</body>
</html>
