<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon-Sync 6.0 | The Overlord</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #8b5cf6; --cyan: #06b6d4; }
        body { background: #010102; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; height: 100vh; overflow: hidden; }
        .cyber-grid { background-image: radial-gradient(circle at 2px 2px, rgba(139, 92, 246, 0.05) 1px, transparent 0); background-size: 32px 32px; }
        .lyric-line { transition: all 0.2s cubic-bezier(0.23, 1, 0.32, 1); opacity: 0.05; transform: scale(0.9); }
        .lyric-active { opacity: 1; transform: scale(1.1); color: #fff; text-shadow: 0 0 25px var(--neon); font-weight: 800; }
        .related-card:hover { border-color: var(--cyan); background: rgba(6, 182, 212, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.03); }
        #pitch-meter { transition: height 0.1s ease; }
    </style>
</head>
<body class="cyber-grid flex flex-col h-screen">

    <div id="setup-screen" class="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-6">
        <div class="max-w-xl w-full text-center space-y-8">
            <h1 class="text-7xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-violet-500 via-fuchsia-500 to-cyan-400">NEON-SYNC</h1>
            <div class="glass p-10 rounded-[2rem] border-violet-500/20 space-y-6">
                <input type="text" id="video-url" class="w-full bg-black/50 border border-white/10 p-5 rounded-2xl outline-none focus:border-cyan-500 text-center text-xl font-mono" placeholder="COLE O LINK DO YOUTUBE">
                <button onclick="bootSystem()" class="w-full bg-violet-600 hover:bg-violet-500 py-5 rounded-2xl font-black text-2xl tracking-[0.2em] transition-all shadow-2xl shadow-violet-900/40">ENGAGE SYSTEM</button>
            </div>
        </div>
    </div>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-64 glass border-r border-white/5 flex flex-col p-4 gap-4 hidden lg:flex">
            <h3 class="text-[10px] uppercase tracking-[0.3em] text-cyan-400 font-bold px-2">Related Hits</h3>
            <div id="related-list" class="flex-1 space-y-3 overflow-y-auto no-scrollbar">
                </div>
        </aside>

        <div class="flex-1 flex flex-col relative">
            <div id="player" class="flex-1 pointer-events-none"></div>
            
            <div class="absolute top-8 left-8 flex items-start gap-6 pointer-events-none">
                <div class="glass px-8 py-4 rounded-3xl border-l-4 border-l-cyan-500">
                    <p class="text-[10px] uppercase tracking-widest text-white/40">Current Score</p>
                    <p id="score" class="text-6xl font-bold font-mono tracking-tighter">000000</p>
                </div>
                <div class="glass p-4 rounded-2xl flex flex-col items-center gap-2">
                    <div class="w-3 h-24 bg-white/5 rounded-full relative overflow-hidden">
                        <div id="pitch-meter" class="absolute bottom-0 w-full bg-cyan-400 h-0 shadow-[0_0_15px_#06b6d4]"></div>
                    </div>
                    <span class="text-[8px] uppercase font-mono">Pitch</span>
                </div>
            </div>

            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div id="active-lyric-big" class="text-6xl font-black text-center max-w-4xl px-10 transition-all duration-300"></div>
            </div>
        </div>

        <div class="w-1/3 glass border-l border-white/5 flex flex-col relative">
            <div id="lyrics-container" class="flex-1 overflow-y-auto py-[50vh] px-12 space-y-16 no-scrollbar scroll-smooth">
                </div>
        </div>
    </main>

    <footer class="h-24 glass border-t border-white/5 flex items-center justify-between px-10 z-[60]">
        <div class="flex gap-10 items-center">
            <div class="flex flex-col">
                <span class="text-[10px] uppercase text-white/30 tracking-widest">Calibration</span>
                <div class="flex items-center gap-4">
                    <button onclick="adjustSync(-0.05)" class="text-cyan-400 hover:text-white">←</button>
                    <span id="offset-display" class="font-mono text-xl font-bold">0.00s</span>
                    <button onclick="adjustSync(0.05)" class="text-cyan-400 hover:text-white">→</button>
                </div>
            </div>
            <p class="text-[10px] text-white/20 font-mono leading-tight">SYST. STATUS: <span class="text-green-500">OPTIMAL</span><br>PITCH SENSOR: ACTIVE</p>
        </div>

        <div class="flex gap-4">
            <button onclick="location.reload()" class="px-8 py-3 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl text-xs font-bold uppercase tracking-widest transition-all">Reset</button>
        </div>
    </footer>

    <script>
        let player, audioCtx, analyser, dataArray, lyrics = [];
        let score = 0, currentVideoId = '';
        let timeOffset = -0.25;

        // Inicia o sistema
        async function bootSystem(vidId = null) {
            const url = document.getElementById('video-url').value;
            const id = vidId || extractVideoID(url);
            if(!id) return alert("Link inválido");
            
            currentVideoId = id;
            document.getElementById('setup-screen').classList.add('opacity-0');
            setTimeout(() => document.getElementById('setup-screen').style.display = 'none', 500);

            try {
                // 1. Meta Data Clean Up
                const meta = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`).then(r => r.json());
                const cleanQuery = meta.title.replace(/\(Official Video\)|\[Official Video\]|Music Video|Lyrics|HD|HQ/gi, '').trim();

                // 2. Fetch Lyrics + Related
                const lrc = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(cleanQuery)}`).then(r => r.json());
                const sync = lrc.find(i => i.syncedLyrics);
                if(!sync) throw new Error("Letras sincronizadas não encontradas.");

                parseLRC(sync.syncedLyrics);
                renderLyrics();
                loadPlayer(id);
                initAudio();
                updateRelated(cleanQuery); // Simula busca de relacionados via query

            } catch (err) {
                alert(err.message);
                location.reload();
            }
        }

        function parseLRC(lrc) {
            lyrics = [];
            const reg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lrc.split('\n').forEach(line => {
                const m = reg.exec(line);
                if (m) {
                    const time = parseInt(m[1])*60 + parseInt(m[2]) + (m[3].length === 3 ? m[3]/1000 : m[3]/100);
                    lyrics.push({ time, text: line.replace(reg, '').trim() });
                }
            });
        }

        function loadPlayer(id) {
            if(!player) {
                player = new YT.Player('player', {
                    height: '100%', width: '100%', videoId: id,
                    playerVars: { autoplay: 1, controls: 0, modestbranding: 1, rel: 0 },
                    events: { onStateChange: (e) => { if(e.data === 1) loop(); } }
                });
            } else {
                player.loadVideoById(id);
            }
        }

        function loop() {
            if (player.getPlayerState() !== 1) return;
            const now = player.getCurrentTime() + timeOffset;

            lyrics.forEach((l, i) => {
                const el = document.getElementById(`lyric-${i}`);
                if (now >= l.time && (i === lyrics.length - 1 || now < lyrics[i+1].time)) {
                    if (!el.classList.contains('lyric-active')) {
                        document.querySelectorAll('.lyric-line').forEach(x => x.classList.remove('lyric-active'));
                        el.classList.add('lyric-active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        document.getElementById('active-lyric-big').innerText = l.text;
                    }
                    processPerformance();
                }
            });
            requestAnimationFrame(loop);
        }

        function processPerformance() {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0, peak = 0;
            for(let v of dataArray) {
                sum += v;
                if(v > peak) peak = v;
            }
            const vol = sum / dataArray.length;
            
            // UI do Pitch
            document.getElementById('pitch-meter').style.height = `${(peak/255)*100}%`;

            if (vol > 35) {
                score += Math.floor(vol / 4);
                document.getElementById('score').innerText = score.toString().padStart(6, '0');
            }
        }

        // Simulação de vídeos relacionados clicáveis
        async function updateRelated(query) {
            const list = document.getElementById('related-list');
            list.innerHTML = `<div class="text-white/20 text-[10px]">SEARCHING NEXT TRACKS...</div>`;
            
            // Aqui você usaria a API do YouTube, mas vamos simular para manter a fluidez
            const mock = [
                { id: 'dQw4w9WgXcQ', title: 'Never Gonna Give You Up' },
                { id: 'CevxZvSJLk8', title: 'Roar - Katy Perry' },
                { id: 'fJ9rUzIMcZQ', title: 'Bohemian Rhapsody' }
            ];

            list.innerHTML = mock.map(m => `
                <div onclick="bootSystem('${m.id}')" class="related-card glass p-3 rounded-xl border border-white/5 cursor-pointer transition-all">
                    <p class="text-xs font-bold truncate">${m.title}</p>
                    <p class="text-[9px] text-cyan-500 uppercase">Load Sync</p>
                </div>
            `).join('');
        }

        async function initAudio() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            audioCtx.createMediaStreamSource(stream).connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function adjustSync(v) {
            timeOffset = parseFloat((timeOffset + v).toFixed(2));
            document.getElementById('offset-display').innerText = timeOffset.toFixed(2) + 's';
        }

        function extractVideoID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : false;
        }

        function renderLyrics() {
            document.getElementById('lyrics-container').innerHTML = lyrics.map((l, i) => 
                `<div id="lyric-${i}" class="lyric-line text-4xl md:text-5xl uppercase font-bold tracking-tighter">${l.text}</div>`
            ).join('');
        }
    </script>
</body>
</html>
