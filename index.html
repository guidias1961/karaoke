<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon-Sync Pro | Final Stage</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050507; color: #e2e8f0; font-family: 'Rajdhani', sans-serif; overflow: hidden; height: 100vh; }
        .neon-border { border: 1px solid rgba(139, 92, 246, 0.3); box-shadow: 0 0 15px rgba(139, 92, 246, 0.1); }
        .lyric-line { transition: all 0.2s ease; opacity: 0.15; filter: blur(1px); transform: scale(0.9); }
        .lyric-active { color: #fff; opacity: 1; transform: scale(1.1); text-shadow: 0 0 20px #8b5cf6; filter: blur(0); font-weight: 700; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <div id="setup-screen" class="fixed inset-0 z-[100] bg-[#050507] flex items-center justify-center p-6">
        <div class="max-w-md w-full space-y-6 text-center">
            <h1 class="text-5xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-violet-500 to-cyan-400">NEON-SYNC</h1>
            <input type="text" id="video-url" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-violet-500 text-center" placeholder="Link do YouTube">
            <button onclick="autoStart()" class="w-full bg-violet-600 hover:bg-violet-500 py-4 rounded-xl font-bold uppercase tracking-widest transition-all">Começar Show</button>
            <p id="status-msg" class="text-xs text-white/30 hidden animate-pulse">Sincronizando banco de dados...</p>
        </div>
    </div>

    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <div class="w-full md:w-3/5 h-1/2 md:h-full relative bg-black">
            <div id="player" class="w-full h-full"></div>
            <canvas id="visualizer" class="absolute bottom-0 left-0 w-full h-24 pointer-events-none opacity-50"></canvas>
        </div>

        <div class="w-full md:w-2/5 h-1/2 md:h-full flex flex-col relative bg-[#08080a] border-l border-white/5">
            <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-[#08080a] to-transparent z-10"></div>
            <div id="lyrics-container" class="flex-1 overflow-y-auto py-[40vh] px-8 space-y-12 no-scrollbar scroll-smooth">
                </div>
            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-[#08080a] to-transparent z-10"></div>
        </div>
    </main>

    <footer class="glass h-24 flex items-center justify-between px-8 z-50">
        <div class="flex flex-col">
            <span class="text-[10px] uppercase tracking-widest text-white/40">Total Score</span>
            <span id="score" class="text-3xl font-bold text-green-400 tabular-nums">000000</span>
        </div>

        <div class="hidden md:flex items-center gap-4 bg-white/5 px-4 py-2 rounded-lg border border-white/5">
            <span class="text-xs uppercase text-white/30">Ajuste de Sync</span>
            <div class="flex gap-2">
                <button onclick="adjustOffset(-0.1)" class="w-8 h-8 flex items-center justify-center bg-white/10 rounded hover:bg-violet-600">-</button>
                <span id="offset-val" class="text-sm font-mono w-12 text-center">0.0s</span>
                <button onclick="adjustOffset(0.1)" class="w-8 h-8 flex items-center justify-center bg-white/10 rounded hover:bg-violet-600">+</button>
            </div>
        </div>

        <div class="flex gap-4">
            <button onclick="resetGame()" class="px-6 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-xs uppercase font-bold transition-all">Próxima</button>
            <button onclick="exitGame()" class="px-6 py-2 bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white rounded-lg text-xs uppercase font-bold transition-all">Sair</button>
        </div>
    </footer>

    <script>
        let player, audioContext, analyser, dataArray, lyrics = [];
        let score = 0;
        let timeOffset = -0.3; // Pequeno delay padrão para ficar "confortável"

        function adjustOffset(val) {
            timeOffset = parseFloat((timeOffset + val).toFixed(1));
            document.getElementById('offset-val').innerText = (timeOffset > 0 ? '+' : '') + timeOffset + 's';
        }

        async function autoStart() {
            const url = document.getElementById('video-url').value;
            const videoId = extractVideoID(url);
            if (!videoId) return alert("Link inválido");

            document.getElementById('status-msg').classList.remove('hidden');

            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
                const data = await response.json();
                const lrcResponse = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(data.title)}`);
                const lrcData = await lrcResponse.json();
                const bestMatch = lrcData.find(i => i.syncedLyrics);

                if (!bestMatch) throw new Error("Letra não encontrada");

                parseLRC(bestMatch.syncedLyrics);
                renderLyrics();
                initPlayer(videoId);
                initAudio();
                document.getElementById('setup-screen').classList.add('hidden');
            } catch (err) {
                alert("Erro: " + err.message);
                document.getElementById('status-msg').classList.add('hidden');
            }
        }

        function parseLRC(lrc) {
            lyrics = [];
            const reg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lrc.split('\n').forEach(line => {
                const m = reg.exec(line);
                if (m) {
                    const time = parseInt(m[1])*60 + parseInt(m[2]) + (m[3].length === 3 ? m[3]/1000 : m[3]/100);
                    lyrics.push({ time, text: line.replace(reg, '').trim() });
                }
            });
        }

        function initPlayer(id) {
            if (player) { player.loadVideoById(id); return; }
            player = new YT.Player('player', {
                height: '100%', width: '100%', videoId: id,
                playerVars: { autoplay: 1, controls: 0, modestbranding: 1 },
                events: { onStateChange: (e) => { if(e.data === 1) updateLoop(); } }
            });
        }

        function updateLoop() {
            if (player.getPlayerState() !== 1) return;
            const currentTime = player.getCurrentTime() + timeOffset; // Aplica o ajuste fino

            lyrics.forEach((l, i) => {
                const el = document.getElementById(`lyric-${i}`);
                if (currentTime >= l.time && (i === lyrics.length - 1 || currentTime < lyrics[i+1].time)) {
                    if (!el.classList.contains('lyric-active')) {
                        document.querySelectorAll('.lyric-line').forEach(x => x.classList.remove('lyric-active'));
                        el.classList.add('lyric-active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    processScore();
                }
            });
            requestAnimationFrame(updateLoop);
        }

        function renderLyrics() {
            document.getElementById('lyrics-container').innerHTML = lyrics.map((l, i) => 
                `<div id="lyric-${i}" class="lyric-line text-3xl md:text-5xl text-center uppercase tracking-tighter">${l.text}</div>`
            ).join('');
        }

        async function initAudio() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext();
            analyser = audioContext.createAnalyser();
            audioContext.createMediaStreamSource(stream).connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVisualizer();
        }

        function processScore() {
            analyser.getByteFrequencyData(dataArray);
            const vol = dataArray.reduce((a,b) => a+b) / dataArray.length;
            if (vol > 40) {
                score += Math.floor(vol / 8);
                document.getElementById('score').innerText = score.toString().padStart(6, '0');
            }
        }

        function drawVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');
            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                ctx.clearRect(0,0,canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(139, 92, 246, 0.5)';
                dataArray.forEach((v, i) => {
                    const h = (v/255)*canvas.height;
                    ctx.fillRect(i*(canvas.width/dataArray.length), canvas.height-h, 2, h);
                });
            }
            draw();
        }

        function extractVideoID(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : false;
        }

        function resetGame() {
            score = 0;
            document.getElementById('score').innerText = "000000";
            document.getElementById('setup-screen').classList.remove('hidden');
        }

        function exitGame() {
            window.location.reload();
        }
    </script>
</body>
</html>
